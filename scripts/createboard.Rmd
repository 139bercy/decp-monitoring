---
title: "Données essentielles de la commande publique"
author: "MEF/SG"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    social: menu
---

```{r setup, include=FALSE}
require(flexdashboard)
require(plotly)
require(DT)
require(lubridate)
require(RColorBrewer)
load(file = "output/stats.Rdata")
labels <- c('aife' = "Aife / DUME", 'pes' = "DGFiP / PES marchés", 'emarchespublics' = "e-marchéspublics",
            'grandlyon' = "Grand Lyon", 'marchespublicsinfo' = "marchéspublics.info")
mycolors <- brewer.pal(n = 5, name = "Accent")
```

Dashboard {data-icon="fa-signal"}
=======================================================================

Row
-----------------------------------------------------------------------

### marchés publiés
```{r}
valueBox(sum(nbmarches$nb), icon = "ion-android-folder-open")
```

### marchés publiés les 10 derniers jours
```{r}
valueBox(sum(nbmarches$nb_10J), icon = "ion-ios-clock-outline")
```

### partenaires sans données depuis 10 jours
```{r}
nodata <- sum(nbmarches$nb_10J==0)
valueBox(nodata, icon = "ion-android-alert", 
         color=ifelse(nodata>1, "warning","primary"))
```

Row
-----------------------------------------------------------------------

### Evolution du nombre de marchés (DECP) par source
```{r}
y <- list(title = "nombre de marchés")
x <- list(title = "date de récupération des données")
plot_ly(stats_cumul, x= ~date, y= ~aife, mode= 'lines', type='scatter', name = labels['aife'], 
        stackgroup = 1) %>%
  add_trace(y= ~marchespublicsinfo, name = labels['marchespublicsinfo']) %>%
  add_trace(y= ~pes, name = labels['pes']) %>%
  add_trace(y= ~emarchespublics, name = labels['emarchespublics']) %>%
  add_trace(y= ~grandlyon, name = labels['grandlyon']) %>%
  layout(yaxis=y, xaxis=x, autosize=T, hovermode="closest", legend=list(x=0.1, y=0.9), colorway = mycolors)
```

### Répartition des marchés par source
```{r}
df <- t(stats_cumul[nrow(stats_cumul),-1])
colnames(df) <- c('values')
df <- as.data.frame(df)
df$labels <- rownames(df)
df$labels <- labels[df$labels]
plot_ly(df, labels = ~labels, values = ~values, type = "pie", hole=0.6,
        textposition = 'inside', textinfo = 'label+percent', hoverinfo = 'text',
        text = ~paste(labels, ' : ', values, ' marchés transmis'), showlegend = FALSE) %>%
  layout(autosize=T, colorway = mycolors)
```



Données {data-icon="fa-table"}
=======================================================================

Tableau de comptage des marchés réceptionnés par jour via les différents canaux

```{r}
datatable(stats2, rownames = FALSE, filter = 'top', options = list(pageLength = 20))
```




Mentions légales
=======================================================================

## Objectifs

Ce tableau de bord permet de superviser le processus de construction consolidée des données essentielles de la commande publique.

## Volet technique
Il est hébergé sur la plateforme GitHub.

Il est administré par l'équipe **Bercy Hub** de la délégation au système d'information des ministères économiques et financiers, en lien avec les équipes DAJ.

## Partenaires
Un grand merci aux équipes Aife, DGFiP et des partenaires qui publient leurs données.


